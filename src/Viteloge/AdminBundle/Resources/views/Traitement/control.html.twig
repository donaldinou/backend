{% extends 'VitelogeAdminBundle::layout.html.twig' %}

{% block title %}
  Contrôle de traitement pour {{ traitement.agence.nom }}, {{ traitement.StringTypeTransaction }}
{% endblock %}

{% block sonata_admin_content %}
<div id="notifications">
{% if app.session.hasFlash('error') %}
    <div class="alert alert-error">
        {{ app.session.flash('error') }}
    </div>
{% endif %}
{% if app.session.hasFlash('notice') %}
    <div class="alert alert-success">
        {{ app.session.flash('notice') }}
    </div>
{% endif %}
</div>
{% if not traitement.agence.url is empty %}
<p><a href="{{ traitement.agence.url }}">{{ traitement.agence.url }}</a></p>
{% endif %}
<div class="viteloge-actions">
  <a href="{{ path( 'viteloge_admin_traitement_edit', { id:traitement.idTraitement } ) }}" class="btn btn-small"><i class="icon-pencil"></i> Éditer</a>
  <a href="{{ path( 'viteloge_admin_traitement_test', { id: traitement.idtraitement } ) }}" class="btn btn-small"><i class="icon-play"></i> Tester</a>
</div>

<div class="control">
  <h2>Prochaines URL traitée dans la PILE</h2>
  {% if pile|length > 0 %}
  <ol>
    {% for url in pile %}
    <li><a class="test" href="{{ path( 'viteloge_admin_traitement_test', { id: traitement.id, TypeSource: url.type, source: url.full_url } ) }}">test</a> <a href="{{ url.full_url }}">{{ url.full_url }}</a> <a href="{{ path( 'viteloge_admin_traitement_heapremove', { id:traitement.id,heap_id: url.id }) }}">X</a></li>
    {% endfor %}
  </ol>
  {% else %}
  <p>Pile vide</p>
  {% endif %}

  {% if lastDownload is not null %}
    <h2>Dernier téléchargement</h2>
    {% if lastDownload.resultSize > 0 %}
      <a href="{{ path('viteloge_admin_traitement_lastcontent', {id: traitement.idTraitement }) }}" target="_blank">Afficher la dernière source téléchargée</a>
    {% endif %}
    <p>({{ lastDownload.resultSize / 1024 | number_format( 2 ) }} ko le {{ lastDownload.downloadedAt }})</p>
  {% endif %}

  {% if flags|length > 0 %}
    <h2>Etat du traitement</h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Nombre d'annonces non-traitées</th>
          <th>Nombre d'annonces traitées</th>
          <th>Nombre d'annonces exportées</strong></th>
      </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ flags.unhandled }}</td>
          <td>{{ flags.handled }}</td>
          <td>{{ nbAnnoncesExportees }} {% if flags.handled > 0 %}(<strong>{{ ( nbAnnoncesExportees * 100 / flags.handled ) | number_format(2) }}%</strong>){% endif %}</td>
        </tr>
        </tbody>
    </table>
  {% endif %}


  <div class="control-actions">
    <form action="{{ path( 'viteloge_admin_traitement_modify', { id: traitement.idTraitement } ) }}" method="POST">
      <select name="action">
        <option value="">(Action)</option>
        {% if pile|length > 0 %}
        <optgroup label="Pile">
          <option value="clear_heap">Vider la pile</option>
        </optgroup>
        {% endif %}
        <optgroup label="Annonces">
          <option value="reset_flag">Reset des flags d'annonces</option>
          <option value="file_update">Forcer la mise à jour des fiches</option>
        </optgroup>
        <optgroup label="Traitement">
          <option value="heap_top">Mise en haut de la pile</option>
          <option value="reset_errors">Reset des erreurs</option>
          {% if traitement.Exclus %}
            <option value="reactivate_safe">Désexclure le site (Annuler la fin traitement si elle n'a pas eu lieu)</option>
            <option value="reactivate_continue">Remettre en route (Désexclu et remet en route)</option>
            {% if pile|length == 0 %}
              <option value="end">Forcer la fin traitement (Forcer une suppression massive)</option>
            {% endif %}
            {% if traitement.isPaused %}
              <option value="unpause">Annuler la pause</option>
            {% endif %}
          {% endif %}
        </optgroup>
      </select>
      <input class="btn btn-danger" type="submit" value="Exécuter">
    </form>
  </div>

  <div class="stats">
    <a class="btn action-display" href="{{ path( 'viteloge_admin_traitement_graph', { id: traitement.idTraitement } ) }}">Afficher les stats</a>
  </div>


</div>



{% endblock %}
